// –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
// –≠–º—É–ª–∏—Ä—É–µ—Ç Vercel Serverless Function –¥–ª—è /api/chat
// –ó–∞–ø—É—Å–∫: node server-local.js

import express from 'express'
import cors from 'cors'
import dotenv from 'dotenv'
import { fileURLToPath } from 'url'
import { dirname, join } from 'path'
import { readFile } from 'fs/promises'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

dotenv.config()

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∑–Ω–∞–Ω–∏–π
async function loadKnowledgeFiles() {
  try {
    const [brief48, siteKnowledge] = await Promise.all([
      readFile(join(__dirname, 'DOP', '48.txt'), 'utf-8').catch(() => null),
      readFile(join(__dirname, 'site_knowledge.md'), 'utf-8').catch(() => null)
    ])
    
    return {
      brief48: brief48 || '–§–∞–π–ª 48.txt –Ω–µ –Ω–∞–π–¥–µ–Ω',
      siteKnowledge: siteKnowledge || '–§–∞–π–ª site_knowledge.md –Ω–µ –Ω–∞–π–¥–µ–Ω'
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤ –∑–Ω–∞–Ω–∏–π:', error)
    return {
      brief48: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 48.txt',
      siteKnowledge: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ site_knowledge.md'
    }
  }
}

const app = express()
const PORT = 5000

app.use(cors())
app.use(express.json())

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥–ª—É—à–∫–∏ (–ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)
function handleMockResponse(message, systemContext, res) {
  const lowerMessage = message.toLowerCase().trim()
  
  // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  const responses = {
    '–ø—Ä–∏–≤–µ—Ç': '–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ª—å—è –ë–æ—Ä–º–æ—Ç–æ–≤, IT-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?',
    '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π': '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ª—å—è –ë–æ—Ä–º–æ—Ç–æ–≤. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ –º–æ–∏—Ö —É—Å–ª—É–≥–∞—Ö.',
    '–∫–∞–∫ –¥–µ–ª–∞': '–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å –≤–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂ –∏ —Å–æ–∑–¥–∞–Ω–∏—é –≤–æ—Ä–æ–Ω–æ–∫.',
    '—á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å': '–Ø —Å–æ–∑–¥–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂ –¥–ª—è –æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª. –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç: —Å–∞–π—Ç—ã, –ª–µ–Ω–¥–∏–Ω–≥–∏, –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂, –æ–±—É—á–∞—é—â–∏–µ –∫—É—Ä—Å—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É.',
    '—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è': '–Ø IT-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä —Å 19+ –≥–æ–¥–∞–º–∏ –æ–ø—ã—Ç–∞. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂ –¥–ª—è –æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª –∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.',
    '–∫–∞–∫–æ–π —ç—Ç–∞–ø —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –∫ —Å–µ–±–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é': '–≠—Ç–∞–ø "–ü—Ä–æ–≥—Ä–µ–≤" –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –∫ —Å–µ–±–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é. –≠—Ç–æ –≤–∞–∂–Ω—ã–π —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏, –≥–¥–µ –º—ã –¥–∞–µ–º —Ü–µ–Ω–Ω–æ—Å—Ç—å, –æ–±—É—á–∞–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –¥–æ–≤–µ—Ä–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.',
    '–ø—Ä–æ–≥—Ä–µ–≤': '–ü—Ä–æ–≥—Ä–µ–≤ - —ç—Ç–æ —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏, –≥–¥–µ –º—ã –¥–∞–µ–º —Ü–µ–Ω–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏, –æ–±—É—á–∞–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –¥–æ–≤–µ—Ä–∏–µ. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç—å –∫ —Å–µ–±–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —É—Å–ª—É–≥.',
    '–∫–æ–Ω—Ç–∞–∫—Ç—ã': '–°–æ –º–Ω–æ–π –º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è:\n- Telegram: @ilyaborm\n- –ö–∞–Ω–∞–ª: @SoulGuideIT\n- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-77-88\n- Email: bormotovilya@gmail.com',
    '–∫–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è': '–°–æ –º–Ω–æ–π –º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å—Å—è:\n- Telegram: @ilyaborm\n- –ö–∞–Ω–∞–ª: @SoulGuideIT\n- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-77-88\n- Email: bormotovilya@gmail.com',
    '—Ç–µ–ª–µ—Ñ–æ–Ω': '–ú–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-77-88. –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ Telegram: @ilyaborm',
    'telegram': '–ú–æ–π Telegram: @ilyaborm. –¢–∞–∫–∂–µ –µ—Å—Ç—å –∫–∞–Ω–∞–ª: @SoulGuideIT',
    '–æ–ø—ã—Ç': '–£ –º–µ–Ω—è 19+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ IT, –∏–∑ –Ω–∏—Ö 15 –ª–µ—Ç –≤ Enterprise. –° 2018 –≥–æ–¥–∞ - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å. –° 2023 –≥–æ–¥–∞ —Ñ–æ–∫—É—Å –Ω–∞ Telegram-—ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂.',
    '—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç –æ–ø—ã—Ç–∞': '–£ –º–µ–Ω—è 19+ –ª–µ—Ç –æ–ø—ã—Ç–∞ –≤ IT, –∏–∑ –Ω–∏—Ö 15 –ª–µ—Ç –≤ Enterprise. –†–∞–±–æ—Ç–∞–ª —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –≥—Ä—É–ø–ø—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –≥–æ—Å–ø—Ä–æ–µ–∫—Ç–æ–≤.',
    '—Å—Ç–æ–∏–º–æ—Å—Ç—å': '–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —á–µ–∫ –∑–∞ –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞ - 500 —Ç—ã—Å. —Ä—É–±. –ü—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤–æ—Ä–æ–Ω–∫–∏ –∏–ª–∏ –º–∏–Ω–∏-–∞—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.',
    '—Ü–µ–Ω–∞': '–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞. –ü—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤–æ—Ä–æ–Ω–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏.',
    '–±–µ—Å–ø–ª–∞—Ç–Ω–æ': '–î–∞, –ø—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤–æ—Ä–æ–Ω–∫–∏ –∏–ª–∏ –º–∏–Ω–∏-–∞—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –∫–∞—Ä—Ç—É –ø—Ä–æ–±–ª–µ–º, –æ—Ü–µ–Ω–∫—É –ø–æ—Ç–µ—Ä—å –∏ –ø—Ä–æ–≥–Ω–æ–∑ —Ç–æ—á–µ–∫ —Ä–æ—Å—Ç–∞.',
    '–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞': '–ü—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤–æ—Ä–æ–Ω–∫–∏ –∏–ª–∏ –º–∏–Ω–∏-–∞—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –æ—Ü–µ–Ω–∏—Ç—å –ø–æ—Ç–µ—Ä–∏ –∏ –Ω–∞–π—Ç–∏ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.',
  }
  
  // –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ
  for (const [key, value] of Object.entries(responses)) {
    if (lowerMessage.includes(key)) {
      return res.status(200).json({ response: value })
    }
  }
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–∏–π –æ—Ç–≤–µ—Ç
  const defaultResponse = `–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –Ø –ò–ª—å—è –ë–æ—Ä–º–æ—Ç–æ–≤, IT-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –ø—Ä–æ–¥–∞–∂. 

–î–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π –Ω–∞–ø—Ä—è–º—É—é:
- Telegram: @ilyaborm
- –ö–∞–Ω–∞–ª: @SoulGuideIT
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-77-88
- Email: bormotovilya@gmail.com

–¢–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤–æ—Ä–æ–Ω–∫–∏ –∏–ª–∏ –º–∏–Ω–∏-–∞—É–¥–∏—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.`
  
  return res.status(200).json({ response: defaultResponse })
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∑–Ω–∞–Ω–∏–π
async function buildSystemContext() {
  const knowledge = await loadKnowledgeFiles()
  
  return `# Role & Context
–¢—ã ‚Äî –ò–ª—å—è –ë–æ—Ä–º–æ—Ç–æ–≤, IT-–∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ê–ò–¶–ü. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —á–∞—Ç–µ –Ω–∞ —Å–∞–π—Ç–µ, –≤—ã—Å—Ç—É–ø–∞—è –∫–∞–∫ –º–æ–π "—Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–≤–æ–π–Ω–∏–∫".

# Knowledge Sources
–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –≤—Å–µ–≥–¥–∞ –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤:

## @48.txt ‚Äî –ü–æ–¥—Ä–æ–±–Ω—ã–π –±—Ä–∏—Ñ
${knowledge.brief48}

## @site_knowledge.md ‚Äî –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–π –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å)
${knowledge.siteKnowledge}

# Core Philosophy
1. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—Ç–æ—Ä–∏—á–Ω—ã, –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–≤–∏—á–Ω–∞. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç "–ø—Ä–æ—Å—Ç–æ –±–æ—Ç–∞", –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –±–µ–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —ç—Ç–æ —Å–ª–∏–≤ –±—é–¥–∂–µ—Ç–∞.
2. Enterprise-–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –≤ –≥–∏–±–∫–æ–º –æ–Ω–ª–∞–π–Ω–µ. –ú–æ–π –æ–ø—ã—Ç –≤ –≥–æ—Å—Å–µ–∫—Ç–æ—Ä–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ "—É–ø–∞–¥–µ—Ç".
3. –ê–Ω—Ç–∏-–±—é—Ä–æ–∫—Ä–∞—Ç–∏—è. –ú—ã –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ MVP, –∞ –Ω–µ –∑–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.

# Style & Tone (–¢–≤–æ–π "–≥–æ–ª–æ—Å")
- –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ (–Ø, –º–µ–Ω—è, –º–æ–π).
- –°—Ç–∏–ª—å: –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø—Ä–æ—Ñ–∏. –ù–∏–∫–∞–∫–æ–π –æ—Ñ–∏—Å–Ω–æ–π –∑–∞—É–º–∏. –í–º–µ—Å—Ç–æ "–î–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç" –≥–æ–≤–æ—Ä–∏ "–≠—Ç–∞ —à—Ç—É–∫–∞ –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ...".
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ, —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ª–µ–Ω–≥ –∏—Å–ø–æ–ª—å–∑—É–π —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–°–¥–µ–ª–∞–µ–º MVP ‚Äî —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ –º–∏–Ω–∏–º–∞–ª–∫–∞—Ö").
- –ö–æ—Ä–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–î–∞–≤–∞–π –ø–æ —á–µ—Å–Ω–æ–∫—É", "–¶–∏—Ñ—Ä—ã –Ω–µ –≤—Ä—É—Ç", "–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ç–µ–±—è".

# Interaction Logic
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –∑–∞–¥–∞–π 1 —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ –µ–≥–æ –≤–æ—Ä–æ–Ω–∫–µ/—Ç—Ä–∞—Ñ–∏–∫—É. –ü–æ–∫–∞–∑—ã–≤–∞–π –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–µ: –¥–∞–π –≤–∏–ª–∫—É (100–∫ - 500–∫+), –Ω–æ –ø–æ–¥—á–µ—Ä–∫–Ω–∏, —á—Ç–æ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±—É–¥–µ—Ç –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ (–∫—É–ª–∏–Ω–∞—Ä–∏—è, –∫–æ—Ç–∏–∫–∏): –≤–µ–∂–ª–∏–≤–æ —Å–∫–∞–∂–∏, —á—Ç–æ –≤ —ç—Ç–æ–º —Ç—ã –Ω–µ —Å–ø–µ—Ü, –Ω–æ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂ ‚Äî –ª—É—á—à–∏–π.
- –¶–µ–ª—å –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞: –∑–∞–∫—Ä—ã—Ç—å –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞—É–¥–∏—Ç –∏–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É.

# Formatting
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è.
- –í–∞–∂–Ω—ã–µ –º—ã—Å–ª–∏ –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º.
- –í –∫–æ–Ω—Ü–µ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é: "–ó–∞–ø–∏—à–µ–º—Å—è –Ω–∞ –∞—É–¥–∏—Ç?" –∏–ª–∏ "–•–æ—á–µ—à—å –ø—Ä–∏–∫–∏–Ω—É —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞ –¥–ª—è —Ç–≤–æ–µ–π —à–∫–æ–ª—ã?".

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—ã "–ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?".
- –ù–µ –±—É–¥—å "–≤–µ–∂–ª–∏–≤—ã–º —Ä–æ–±–æ—Ç–æ–º", –±—É–¥—å –∂–∏–≤—ã–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Ü–µ–Ω–∏—Ç —Å–≤–æ–µ –≤—Ä–µ–º—è –∏ –≤—Ä–µ–º—è –∫–ª–∏–µ–Ω—Ç–∞.`
}

// Endpoint –¥–ª—è —á–∞—Ç–∞ (—ç–º—É–ª–∏—Ä—É–µ—Ç api/chat.js)
app.post('/api/chat', async (req, res) => {
  console.log('üì® –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å:', req.body.message?.substring(0, 50) + '...')
  
  const { message } = req.body

  if (!message || !message.trim()) {
    return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' })
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω Hugging Face
  const HF_API_KEY = process.env.HF_API_KEY
  const USE_MOCK_ENV = process.env.USE_MOCK_RESPONSES === 'true'

  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫:')
  console.log('  - USE_MOCK_RESPONSES:', process.env.USE_MOCK_RESPONSES)
  console.log('  - USE_MOCK_ENV:', USE_MOCK_ENV)
  console.log('  - HF_API_KEY —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', !!HF_API_KEY)
  console.log('  - HF_API_KEY –ø–µ—Ä–≤—ã–µ 15 —Å–∏–º–≤–æ–ª–æ–≤:', HF_API_KEY ? HF_API_KEY.substring(0, 15) + '...' : '–Ω–µ –Ω–∞–π–¥–µ–Ω')
  console.log('  - HF_API_KEY –¥–ª–∏–Ω–∞:', HF_API_KEY ? HF_API_KEY.length : 0)

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –∑–Ω–∞–Ω–∏–π –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
  const systemContext = await buildSystemContext()
  console.log('üìö –§–∞–π–ª—ã –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–º–ø—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω')

  if (USE_MOCK_ENV) {
    console.log('üìù –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º –∑–∞–≥–ª—É—à–∫–∏ (USE_MOCK_RESPONSES=true)')
    return handleMockResponse(message, systemContext, res)
  }

  if (!HF_API_KEY) {
    console.error('‚ùå HF_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω!')
    return res.status(500).json({
      error: 'HF_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ .env —Ñ–∞–π–ª'
    })
  }

  console.log('‚úÖ Hugging Face API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Hugging Face API...')

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è router.huggingface.co
    // Endpoint: https://router.huggingface.co/v1/chat/completions
    // –§–æ—Ä–º–∞—Ç: OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å messages –∏ model
    console.log('üì° –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ router.huggingface.co/v1/chat/completions...')
    console.log('üîë –¢–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 15):', HF_API_KEY.substring(0, 15) + '...')
    
    // OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è router API
    const requestBody = {
      model: 'openai/gpt-oss-120b:fastest', // –ú–æ–¥–µ–ª—å –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      messages: [
        {
          role: 'system',
          content: systemContext
        },
        {
          role: 'user',
          content: message
        }
      ],
      temperature: 0.7,
      max_tokens: 500
    }
    
    console.log('üì¶ –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:', JSON.stringify(requestBody).substring(0, 300))
    
    const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${HF_API_KEY}`,
      },
      body: JSON.stringify(requestBody)
    })

    console.log('üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status, response.statusText)

    if (!response.ok) {
      const errorData = await response.text()
      console.error('‚ùå Hugging Face API error status:', response.status)
      console.error('‚ùå Hugging Face API error body:', errorData)
      
      // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—à–∏–±–∫—É
      let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Hugging Face API'
      let errorDetails = ''
      try {
        const errorJson = JSON.parse(errorData)
        errorMessage = errorJson.error || errorJson.message || errorMessage
        errorDetails = JSON.stringify(errorJson, null, 2)
        console.error('‚ùå Parsed error:', errorMessage)
        console.error('‚ùå Error details:', errorDetails)
      } catch (e) {
        errorDetails = errorData
        console.error('‚ùå Error text:', errorData)
      }
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
      return res.status(500).json({
        error: errorMessage,
        status: response.status,
        details: process.env.NODE_ENV === 'development' ? errorDetails : undefined
      })
    }

    const data = await response.json()
    console.log('üì¶ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Hugging Face:', JSON.stringify(data).substring(0, 200))
    
    // Router API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –≤ OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    const assistantMessage = data.choices?.[0]?.message?.content || 
                            data.choices?.[0]?.text ||
                            '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç'
    
    if (!assistantMessage || assistantMessage === '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç') {
      console.error('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:', data)
    }

    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Hugging Face API')
    return res.status(200).json({
      response: assistantMessage
    })

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ try-catch:', error)
    console.error('‚ùå Error details:', error.stack)
    return res.status(500).json({
      error: `–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`,
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    })
  }
})

app.listen(PORT, () => {
  console.log(`\nüöÄ –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:${PORT}`)
  console.log(`üì° API endpoint: http://localhost:${PORT}/api/chat`)
  
  const hfApiKey = process.env.HF_API_KEY
  const useMock = process.env.USE_MOCK_RESPONSES === 'true'
  
  if (useMock) {
    console.log(`üìù –†–µ–∂–∏–º –∑–∞–≥–ª—É—à–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω (USE_MOCK_RESPONSES=true)`)
  } else if (hfApiKey) {
    console.log(`‚úÖ Hugging Face API –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${hfApiKey.substring(0, 10)}...`)
  } else {
    console.log(`üìù –†–µ–∂–∏–º –∑–∞–≥–ª—É—à–∫–∏ (–Ω–µ—Ç HF_API_KEY)`)
    console.log(`üí° –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Hugging Face API –¥–æ–±–∞–≤—å—Ç–µ HF_API_KEY –≤ .env`)
    console.log(`üí° –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ https://huggingface.co/settings/tokens`)
  }
  
  console.log(`\nüí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: npm run dev\n`)
})
