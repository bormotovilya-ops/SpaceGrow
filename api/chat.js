// Vercel Serverless Function для бесплатного чата
// Поддерживает режим заглушки и Hugging Face API

// Функция для обработки заглушки
function handleMockResponse(message) {
  const lowerMessage = message.toLowerCase().trim()
  
  const responses = {
    'привет': 'Привет! Я Илья Бормотов, IT-интегратор и архитектор автоматизированных интеллектуальных цепочек продаж. Чем могу помочь?',
    'здравствуй': 'Здравствуйте! Я Илья Бормотов. Готов ответить на ваши вопросы о моих услугах.',
    'как дела': 'Отлично, спасибо! Готов помочь вам с вопросами по автоматизации продаж и созданию воронок.',
    'что ты делаешь': 'Я создаю автоматизированные цепочки продаж для онлайн-школ. Это включает: сайты, лендинги, воронки продаж, обучающие курсы и интеграцию всех элементов в единую систему.',
    'чем занимаешься': 'Я IT-интегратор с 19+ годами опыта. Специализируюсь на создании автоматизированных интеллектуальных цепочек продаж для онлайн-школ и экспертов.',
    'какой этап цепочки продаж помогает расположить к себе аудиторию': 'Этап "Прогрев" помогает расположить к себе аудиторию. Это важный этап воронки, где мы даем ценность, обучаем и создаем доверие перед предложением.',
    'прогрев': 'Прогрев - это этап воронки, где мы даем ценность аудитории, обучаем и создаем доверие. Это помогает расположить к себе клиентов перед предложением услуг.',
    'контакты': 'Со мной можно связаться:\n- Telegram: @ilyaborm\n- Канал: @SoulGuideIT\n- Телефон: +7 (999) 123-77-88\n- Email: bormotovilya@gmail.com',
    'как связаться': 'Со мной можно связаться:\n- Telegram: @ilyaborm\n- Канал: @SoulGuideIT\n- Телефон: +7 (999) 123-77-88\n- Email: bormotovilya@gmail.com',
    'телефон': 'Мой телефон: +7 (999) 123-77-88. Также можете написать в Telegram: @ilyaborm',
    'telegram': 'Мой Telegram: @ilyaborm. Также есть канал: @SoulGuideIT',
    'опыт': 'У меня 19+ лет опыта в IT, из них 15 лет в Enterprise. С 2018 года - индивидуальный предприниматель. С 2023 года фокус на Telegram-экосистеме и автоматизации продаж.',
    'сколько лет опыта': 'У меня 19+ лет опыта в IT, из них 15 лет в Enterprise. Работал руководителем группы аналитики для крупных госпроектов.',
    'стоимость': 'Стоимость зависит от проекта. Максимальный чек за одного бота - 500 тыс. руб. Предлагаю бесплатную диагностику воронки или мини-аудит бизнес-процессов.',
    'цена': 'Стоимость зависит от проекта. Предлагаю бесплатную диагностику воронки для оценки вашей ситуации.',
    'бесплатно': 'Да, предлагаю бесплатную диагностику воронки или мини-аудит бизнес-процессов. Это включает карту проблем, оценку потерь и прогноз точек роста.',
    'диагностика': 'Предлагаю бесплатную диагностику воронки или мини-аудит бизнес-процессов. Это поможет выявить проблемы, оценить потери и найти точки роста. Свяжитесь со мной для подробностей.',
  }
  
  for (const [key, value] of Object.entries(responses)) {
    if (lowerMessage.includes(key)) {
      return value
    }
  }
  
  return `Спасибо за вопрос! Я Илья Бормотов, IT-интегратор и архитектор автоматизированных интеллектуальных цепочек продаж. 

Для более подробного ответа свяжитесь со мной напрямую:
- Telegram: @ilyaborm
- Канал: @SoulGuideIT
- Телефон: +7 (999) 123-77-88
- Email: bormotovilya@gmail.com

Также предлагаю бесплатную диагностику воронки или мини-аудит бизнес-процессов.`
}

export default async function handler(req, res) {
  // Разрешаем только POST запросы
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  // CORS заголовки
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader('Access-Control-Allow-Methods', 'POST')
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type')

  const { message } = req.body

  if (!message || !message.trim()) {
    return res.status(400).json({ error: 'Сообщение не может быть пустым' })
  }

  // Проверяем режим заглушки
  const USE_MOCK = process.env.USE_MOCK_RESPONSES === 'true'
  const HF_API_KEY = process.env.HF_API_KEY

  if (USE_MOCK || !HF_API_KEY) {
    const response = handleMockResponse(message)
    return res.status(200).json({ response })
  }

  try {
    // Контекст для нейросети
    const systemContext = `Ты - Илья Бормотов, IT-интегратор и архитектор автоматизированных интеллектуальных цепочек продаж (АИЦП).

О тебе:
- 19+ лет опыта в IT, из них 15 лет в Enterprise
- Работал руководителем группы аналитики для крупных госпроектов (стоимость сотни миллионов рублей)
- С 2018 года - индивидуальный предприниматель
- С 2023 года фокус на Telegram-экосистеме и автоматизации продаж
- Реализовано более 30 ботов и автоворонок за последние 3 года
- Максимальный чек за одного бота - 500 тыс. руб.

Твоя специализация:
- Архитектор систем продаж, а не просто разработчик инструментов
- Создаю автоматизированные цепочки продаж для онлайн-школ
- Работаю с экспертами и онлайн-школами с доходом от 200 тысяч до 1-2 миллионов в месяц
- Комплексный подход: диагностика → проектирование → интеграция → автоматизация

Что ты делаешь:
1. Автоматизированные цепочки продаж
2. Сайты и лендинги
3. Воронки продаж
4. Обучающие курсы (боты/GetCourse)
5. Интеграция всех элементов в единую систему

Твой подход:
- Цели — фундамент: сначала проектирую логику и KPI, потом внедряю софт
- Единая экосистема: связываю трафик, CRM и аналитику в систему
- Работа на ROI: зарабатываю вместе с клиентом, приоритет — превратить бюджет в прибыль
- Прозрачный темп: без бюрократии, быстрая реакция, запуск MVP в кратчайшие сроки

Бесплатный оффер:
- Диагностика воронки или мини-аудит бизнес-процессов
- Карта проблем, оценка потерь, прогноз точек роста

Контакты:
- Telegram: @ilyaborm
- Канал: @SoulGuideIT
- Телефон: +7 (999) 123-77-88
- Email: bormotovilya@gmail.com

Твой стиль общения:
- Дружелюбный, но профессиональный
- Говоришь простым языком, без технозанудства
- Всегда на связи, быстрая реакция
- Прозрачность и честность
- Фокус на результат клиента

Важно: Отвечай от первого лица, как будто ты сам Илья. Будь конкретным, используй факты из контекста. Если вопрос не относится к твоей деятельности, вежливо перенаправь на контакты.`

    // Используем правильный формат для router.huggingface.co
    // Endpoint: https://router.huggingface.co/v1/chat/completions
    // Формат: OpenAI-совместимый с messages и model
    const requestBody = {
      model: 'openai/gpt-oss-120b:fastest', // Модель из документации
      messages: [
        {
          role: 'system',
          content: systemContext
        },
        {
          role: 'user',
          content: message
        }
      ],
      temperature: 0.7,
      max_tokens: 500
    }

    const response = await fetch('https://router.huggingface.co/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${HF_API_KEY}`,
      },
      body: JSON.stringify(requestBody)
    })

    if (!response.ok) {
      // Если ошибка API, переключаемся на заглушку
      const response = handleMockResponse(message)
      return res.status(200).json({ response })
    }

    const data = await response.json()
    // Router API возвращает ответ в OpenAI-совместимом формате
    const assistantMessage = data.choices?.[0]?.message?.content || 
                            data.choices?.[0]?.text ||
                            handleMockResponse(message)

    return res.status(200).json({
      response: assistantMessage
    })

  } catch (error) {
    console.error('Error:', error)
    return res.status(500).json({
      error: `Ошибка при обработке запроса: ${error.message}`
    })
  }
}
